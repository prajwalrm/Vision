#!/bin/bash

TEMP_DIR="/temp"
EFS_DIR="/efs/dist/ion/java"

# Loop through all .jar files in the TEMP_DIR
for jar_file in "$TEMP_DIR"/*.jar; do
    # Extract the filename without extension
    jar_name=$(basename "$jar_file" .jar)

    # Extract package name (assuming naming convention: package-name-version.jar)
    package_name=$(echo "$jar_name" | awk -F '-' '{OFS="-"; $NF=""; print $0}' | sed 's/-$//')
    version=$(echo "$jar_name" | awk -F '-' '{print $NF}')

    # Full package identifier
    full_package="${package_name}-${version}"

    echo "Processing $full_package ..."

    # Step 1: Create release
    efs create release ion java "$full_package"

    # Step 2: Install the package
    efs create install ion java "$full_package" common

    # Step 3: Navigate to install location
    INSTALL_DIR="$EFS_DIR/$full_package/install/common"
    mkdir -p "$INSTALL_DIR/lib/$package_name"

    # Step 4: Copy files
    cp "$TEMP_DIR/$jar_name.jar" "$INSTALL_DIR/lib/$package_name/"
    cp "$TEMP_DIR/$jar_name.pom" "$INSTALL_DIR/lib/$package_name/"

    # Step 5: Checkpoint and distribute
    efs checkpoint release ion java "$full_package"
    efs dist release ion java "$full_package" --global

    echo "$full_package processed successfully."
done

echo "All packages have been processed."
